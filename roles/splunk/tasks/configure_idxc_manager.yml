---
- name: Run splunk version command to check currently installed version
  include_tasks: check_splunk_version.yml

# Splunk version < 8.1 supports mode=master
# https://docs.splunk.com/Documentation/Splunk/8.0.9/Indexer/Configuremasterwithserverconf
# Splunk version >= 8.1 supports mode=manager
# https://docs.splunk.com/Documentation/Splunk/latest/Indexer/Configuremanagerwithserverconf
- name: Setting clustering mode based on Splunk version number
  set_fact:
    mode_value: "{% if splunk_version_release | float < 8.1 %}master{% else %}manager{% endif %}"

- name: Set config_options to an empty dictionary
  set_fact:
    config_options: {}

- name: Project Idempotent | Define configuration options and their desired values
  set_fact:
    config_options:
      mode: { expected_value: "{{ mode_value}}", current_value: null }
      replication_factor: { expected_value: "{{ splunk_idxc_rf }}", current_value: null }
      search_factor: { expected_value: "{{ splunk_idxc_sf }}", current_value: null }
      pass4SymmKey: { expected_value: "{{ splunk_idxc_key }}", current_value: null, splunk_encrypted_variable: true }
      cluster_label: { expected_value: "{{ splunk_idxc_label }}", current_value: null }

- name: Include task to check and compare current configuration values
  include_tasks: check_splunk_configuration_value.yml
  loop: "{{ config_options | dict2items }}"
  loop_control:
    loop_var: config_item
  vars:
    write_result_to_config_options: true
    req_secret_conf: server
    req_secret_section: clustering

# - name: print config_options after fetching
#   debug:
#     msg: "{{ config_options }}"

- name: Initialize re_initialization_required to false
  set_fact:
    re_initialization_required: false

- name: Check if re-initialization is required based on diff in config_options
  set_fact:
    re_initialization_required: true
  when: (item.value.expected_value | string) != (item.value.current_value | string)
  loop: "{{ config_options | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Configure clustering stanza for cluster manager node
  ini_file:
    path: "{{ splunk_home }}/etc/system/local/server.conf"
    section: clustering
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    mode: 0644
    owner: "{{ splunk_nix_user }}"
    group: "{{ splunk_nix_group }}"
  become: true
  notify: 
    - restart splunk
    - wait for splunkd
  no_log: true
  loop:
    - { option: "mode", value: "{{ mode_value}}" }
    - { option: "replication_factor", value: "{{ splunk_idxc_rf }}" }
    - { option: "search_factor", value: "{{ splunk_idxc_sf }}" }
    - { option: "pass4SymmKey", value: "{{ splunk_idxc_key }}" }
    - { option: "cluster_label", value: "{{ splunk_idxc_label }}" }
  when: re_initialization_required
